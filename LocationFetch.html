<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>AI Crisis Detection - Mobile Enhanced Tracker</title>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<style>
  html, body { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; }
  #map { height: 100%; width: 100%; }

  /* Floating info card */
  #infoCard { 
    position: absolute; 
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    min-width: 280px; 
    max-width: 95%;
  }

  .card { background: rgba(255,255,255,0.95); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);}
  .card-body i { margin-right: 6px; color: #0d6efd; }
  .card-body p { margin-bottom: 0.3rem; font-size: 0.9rem; }
  #locationLink { margin-top: 8px; font-size: 0.9rem; }

  /* Animated accuracy circle */
  .accuracy-circle { stroke-width: 2; fill-opacity: 0.2; animation: pulse 2s infinite; }
  @keyframes pulse {
    0% { opacity: 0.2; transform: scale(0.9);}
    50% { opacity: 0.4; transform: scale(1.05);}
    100% { opacity: 0.2; transform: scale(0.9);}
  }

  /* Mobile adjustments */
  @media (max-width: 576px) {
    .card-body p { font-size: 0.8rem; }
    #locationLink { padding: 6px 12px; font-size: 0.8rem; }
    #infoCard { top: 10px; min-width: 240px; }
  }
</style>
</head>
<body>

<div id="map"></div>

<div id="infoCard" class="card">
  <div class="card-body text-center">
    <h6 class="card-title"><i class="fas fa-map-marker-alt"></i> Live Tracker</h6>
    <p id="status"><i class="fas fa-map-pin"></i> Initializing...</p>
    <p id="accuracy"><i class="fas fa-bullseye"></i> Accuracy: --</p>
    <p id="speed"><i class="fas fa-tachometer-alt"></i> Speed: --</p>
    <p id="time"><i class="fas fa-clock"></i> Time: --</p>
    <a id="locationLink" class="btn btn-primary btn-sm" href="#" target="_blank" style="display:none;">
      <i class="fas fa-location-arrow"></i> Open in Google Maps
    </a>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const status = document.getElementById('status');
const locationLink = document.getElementById('locationLink');
const accuracyDiv = document.getElementById('accuracy');
const speedDiv = document.getElementById('speed');
const timeDiv = document.getElementById('time');

// Initialize map
let map = L.map('map').setView([0,0], 18);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// Custom GPS marker
let gpsIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
    iconSize: [40, 40],
    iconAnchor: [20, 20]
});
let marker = L.marker([0,0], {icon: gpsIcon, rotationAngle: 0, rotationOrigin: "center"}).addTo(map);

// Animated accuracy circle
let accuracyCircle = L.circle([0,0], {radius: 0, color: 'green', opacity:0.3}).addTo(map);

// Smooth polyline path
let path = [];
let polyline = L.polyline(path, {color: 'orange', weight: 4, smoothFactor: 1.5}).addTo(map);

// Buffer for smoothing
let bestReading = null;
let readingsBuffer = [];
const BUFFER_SIZE = 10;

function updateBestReading(lat, lon, accuracy, speed, timestamp) {
    readingsBuffer.push({lat, lon, accuracy, speed, timestamp});
    if (readingsBuffer.length > BUFFER_SIZE) readingsBuffer.shift();
    readingsBuffer.sort((a, b) => a.accuracy - b.accuracy);
    bestReading = readingsBuffer[0];
}

function updateMap() {
    if (!bestReading) return;
    const { lat, lon, accuracy, speed, timestamp, heading } = bestReading;

    const mapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
    locationLink.href = mapsUrl;
    locationLink.style.display = 'inline-block';

    status.innerHTML = `<i class="fas fa-map-pin"></i> Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
    accuracyDiv.innerHTML = `<i class="fas fa-bullseye"></i> Accuracy: ${accuracy.toFixed(1)} m`;
    speedDiv.innerHTML = `<i class="fas fa-tachometer-alt"></i> Speed: ${(speed||0).toFixed(1)} m/s`;
    timeDiv.innerHTML = `<i class="fas fa-clock"></i> Time: ${new Date(timestamp).toLocaleTimeString()}`;

    marker.setLatLng([lat, lon]);
    if(heading) marker.setRotationAngle(heading);

    accuracyCircle.setLatLng([lat, lon]);
    accuracyCircle.setRadius(accuracy);
    accuracyCircle.setStyle({color: accuracy<5?'green':accuracy<10?'orange':'red'});

    map.setView([lat, lon]);
    path.push([lat, lon]);
    polyline.setLatLngs(path);
}

// Geolocation success
function success(position) {
    const { latitude, longitude, accuracy, speed, heading } = position.coords;
    if (accuracy > 50) {
        status.textContent = `Searching for better GPS fix... (Current accuracy: ${accuracy.toFixed(1)}m)`;
        return;
    }
    updateBestReading(latitude, longitude, accuracy, speed, position.timestamp, heading);
    updateMap();
}

// Geolocation error
function error(err) {
    status.textContent = `Error: ${err.message}`;
    locationLink.style.display = 'none';
}

// Start tracking
if (navigator.geolocation) {
    navigator.geolocation.watchPosition(success, error, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 10000
    });
} else {
    status.textContent = "Geolocation not supported by your browser.";
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
